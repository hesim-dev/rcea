<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partitioned Survival Model • rcea</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Partitioned Survival Model">
<meta property="og:description" content="rcea">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131661920-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-131661920-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rcea</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-markov-cohort.html">Simple Markov Cohort Model</a>
    </li>
    <li>
      <a href="../articles/02-markov-cohort-psa.html">Incorporating Probabilistic Sensitivity Analysis</a>
    </li>
    <li>
      <a href="../articles/03-markov-cohort-hesim.html">Markov Cohort Model with hesim</a>
    </li>
    <li>
      <a href="../articles/04-mstate.html">Semi-Markov Multi-state Model</a>
    </li>
    <li>
      <a href="../articles/05-psm.html">Partitioned Survival Model</a>
    </li>
    <li>
      <a href="../articles/06-cea.html">Cost-effectiveness Analysis</a>
    </li>
    <li class="divider">
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Slides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../slides-3hr.pdf">3 hour course</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hesim-dev/rcea/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="05-psm_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Partitioned Survival Model</h1>
            
            <h4 class="date">2021-08-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hesim-dev/rcea/blob/master/vignettes/05-psm.Rmd"><code>vignettes/05-psm.Rmd</code></a></small>
      <div class="hidden name"><code>05-psm.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>While multi-state models can be used to estimate the parameters of a state transition model (STM) in a very flexible manner, data availability can make it difficult (or infeasible) to fit such a model. This is often the case when an evidence synthesis model based on summary level data is used to parameterize the STM. For example, in oncology, published articles of clinical trials often provide survival curves of progression-free survival (PFS) and overall survival (OS), but do not release information on time to event (and censoring) for each transition. In this setting partitioned survival analysis may consequently be a simpler approach.</p>
<p>We will use the same packages as in the <a href="04-mstate.html">“Semi-Markov Multi-state Model”</a> tutorial.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://hesim-dev.github.io/rcea/">"rcea"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://hesim-dev.github.io/hesim/">"hesim"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com">"data.table"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org">"ggplot2"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/chjackson/flexsurv-dev">"flexsurv"</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span> <span class="co"># Make PSA reproducible</span></code></pre></div>
</div>
<div id="theory" class="section level1">
<h1 class="hasAnchor">
<a href="#theory" class="anchor"></a>Theory</h1>
<p>An 3-state partitioned survival model (PSM) simulates the probability that a patient is in each of 3 distinct health states at a given point of time when treated by a particular therapy. State membership is estimated from 2 survival curves (e.g., PFS and OS) using an “area under the curve” approach. Specifically, letting <span class="math inline">\(S_{PFS}(t)\)</span> be the PFS survival curve and <span class="math inline">\(S_{OS}(t)\)</span> be the OS curve, the probabilities of being in the stable, progression, and death states at time <span class="math inline">\(t\)</span> are <span class="math inline">\(S_{PFS}(t)\)</span>, <span class="math inline">\(S_{OS}(t) - S_{PFS}(t)\)</span>, and <span class="math inline">\(1 - S_{OS}(t)\)</span>, respectively. For a more general N-state case, refer to the <a href="https://hesim-dev.github.io/hesim/articles/psm.html"><code>hesim</code> vignette on partitioned survival models (PSMs)</a> and the <a href="http://nicedsu.org.uk/technical-support-documents/partitioned-survival-analysis-tsd/">NICE Decision Support report on partitioned survival analysis</a>.</p>
<p>Partitioned survival analysis can also be used to parameterize a time-inhomogeneous cohort discrete time state transition model (cDTSTM). This approach is identical to the PSM, except that discrete model cycles must be used. In a 3-state model, the transition probability matrix at time <span class="math inline">\(t\)</span> is given by,</p>
<p><span class="math display">\[
\begin{pmatrix}
C &amp; p_1 - p_2 &amp; p_2\\
0 &amp; C &amp; p_2 \\
0 &amp; 0 &amp; 1,
\end{pmatrix}
\]</span> where <span class="math inline">\(C\)</span> is refers to complement of the sum of the remaining elements in a row and <span class="math inline">\(p_1\)</span> and <span class="math inline">\(p_2\)</span> are transition probabilities derived from survival curves. In the PFS and OS example with model cycles of length <span class="math inline">\(u\)</span>, <span class="math inline">\(p_1 = 1 - s_{PFS}(t)/s_{PFS}(t-u)\)</span> and <span class="math inline">\(p_2 = 1 - s_{OS}(t)/s_{OS}(t-u)\)</span>. From this matrix, one can immediately see that a PSM—in contrast to a multi-state model—make the implausible assumption that the probability of a transition from stable to death and from progression to death are equal. See the <a href="https://cran.r-project.org/web/packages/heemod/vignettes/j_survival.html"><code>heemod</code> vignette on survival models</a> for an example cDTSTM based on a partitioned survival analysis.</p>
</div>
<div id="model-setup" class="section level1">
<h1 class="hasAnchor">
<a href="#model-setup" class="anchor"></a>Model setup</h1>
<p>We set up the model in the same way as in the multi-state model, except that since PSMs are cohort models, we no longer need to simulate a large number of patients to compute expected values. Instead, we will simulate separate cohorts of representative patients of varying ages and sexes. The overall estimates are (weighted) averages across patients, although in this example we will assume that each representative patient should receive equal weight. Note that we could have also used <code>grp_id</code> option in <code><a href="https://hesim-dev.github.io/hesim/reference/hesim_data.html">hesim::hesim_data()</a></code> to assign patients to groups so that we could conduct subgroup analysis.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patients</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span> 
  patient_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,
  patient_wt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, <span class="co"># Each patient has same weight</span>
  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">45</span>, <span class="fl">45</span>, <span class="fl">65</span>, <span class="fl">65</span><span class="op">)</span>,
  female <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  state_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
  state_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Stable"</span>, <span class="st">"Progression"</span><span class="op">)</span> <span class="co"># Non-death health states</span>
<span class="op">)</span>

<span class="va">strategies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  strategy_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,
  strategy_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SOC"</span>, <span class="st">"New"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">hesim_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/hesim_data.html">hesim_data</a></span><span class="op">(</span>
  patients <span class="op">=</span> <span class="va">patients</span>,
  strategies <span class="op">=</span> <span class="va">strategies</span>,
  states <span class="op">=</span> <span class="va">states</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">hesim_dat</span><span class="op">)</span></code></pre></div>
<pre><code>## $strategies
##   strategy_id strategy_name
## 1           1           SOC
## 2           2           New
## 
## $patients
##    patient_id patient_wt age female
## 1:          1       0.25  45      0
## 2:          2       0.25  45      1
## 3:          3       0.25  65      0
## 4:          4       0.25  65      1
## 
## $states
##    state_id  state_name
## 1:        1      Stable
## 2:        2 Progression
## 
## attr(,"class")
## [1] "hesim_data"</code></pre>
<p>As in the multi-state modeling tutorial, we will use <code><a href="https://hesim-dev.github.io/hesim/reference/get_labels.html">get_labels()</a></code> to assign labels to the ID variables in order to facilitate nicer presentation of results.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/get_labels.html">get_labels</a></span><span class="op">(</span><span class="va">hesim_dat</span><span class="op">)</span></code></pre></div>
</div>
<div id="parameter-estimation" class="section level1">
<h1 class="hasAnchor">
<a href="#parameter-estimation" class="anchor"></a>Parameter estimation</h1>
<div id="survival-models" class="section level2">
<h2 class="hasAnchor">
<a href="#survival-models" class="anchor"></a>Survival models</h2>
<p>Multi-state models estimate the hazards between all transitions in an integrated manner. PSMs are, in contrast, parameterized by estimating separate survival models for different endpoints. The data consists of one row per patient. In the oncology example, the two endpoints are PFS and OS. We leverage the function <code><a href="https://hesim-dev.github.io/hesim/reference/as_pfs_os.html">as_pfs_os()</a></code> from the <code>hesim</code> package to create such data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">onc3</span> <span class="op">&lt;-</span> <span class="fu">hesim</span><span class="fu">::</span><span class="va"><a href="https://hesim-dev.github.io/hesim/reference/onc3.html">onc3</a></span><span class="op">[</span><span class="va">strategy_name</span> <span class="op">!=</span> <span class="st">"New 1"</span><span class="op">]</span>
<span class="va">onc3</span><span class="op">[</span>, <span class="va">strategy_name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span><span class="op">(</span><span class="va">strategy_name</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">onc3</span><span class="op">$</span><span class="va">strategy_name</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"SOC"</span>, <span class="st">"New"</span><span class="op">)</span>
<span class="va">surv_est_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/as_pfs_os.html">as_pfs_os</a></span><span class="op">(</span><span class="va">onc3</span>, patient_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"patient_id"</span>, <span class="st">"female"</span>, <span class="st">"age"</span>,
                                                  <span class="st">"strategy_name"</span><span class="op">)</span><span class="op">)</span>
<span class="va">surv_est_data</span><span class="op">[</span><span class="va">patient_id</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##    patient_id female      age strategy_name pfs_time pfs_status os_status
## 1:          1      0 59.85813           New 2.420226          1         1
## 2:          2      0 62.57282           New 7.497464          0         0
##      os_time
## 1: 14.620258
## 2:  7.497464</code></pre>
<p>To maintain consistency with the multi-state model, we will fit Weibull survival models for both PFS and OS and include an indicator for female as a covariate. The PFS and OS fits are stored in a <code><a href="https://hesim-dev.github.io/hesim/reference/flexsurvreg_list.html">hesim::flexsurvreg_list</a></code>, which is just a list of models fit using <code><a href="https://rdrr.io/pkg/flexsurv/man/flexsurvreg.html">flexsurv::flexsurvreg()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit_pfs_wei</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/flexsurvreg.html">flexsurvreg</a></span><span class="op">(</span>
  <span class="fu">Surv</span><span class="op">(</span><span class="va">pfs_time</span>, <span class="va">pfs_status</span><span class="op">)</span> <span class="op">~</span> <span class="va">strategy_name</span> <span class="op">+</span> <span class="va">female</span>,
  data <span class="op">=</span> <span class="va">surv_est_data</span>,
  dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span>

<span class="va">fit_os_wei</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/flexsurv/man/flexsurvreg.html">flexsurvreg</a></span><span class="op">(</span>
  <span class="fu">Surv</span><span class="op">(</span><span class="va">os_time</span>, <span class="va">os_status</span><span class="op">)</span> <span class="op">~</span> <span class="va">strategy_name</span> <span class="op">+</span> <span class="va">female</span>,
  data <span class="op">=</span> <span class="va">surv_est_data</span>,
  dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span>

<span class="va">psfit_wei</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/flexsurvreg_list.html">flexsurvreg_list</a></span><span class="op">(</span><span class="va">fit_pfs_wei</span>, <span class="va">fit_os_wei</span><span class="op">)</span></code></pre></div>
</div>
<div id="utility-and-costs" class="section level2">
<h2 class="hasAnchor">
<a href="#utility-and-costs" class="anchor"></a>Utility and costs</h2>
<p>Utility and medical costs are setup in the exact same way as in the multi-state model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Utility</span>
<span class="va">utility_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/stateval_tbl.html">stateval_tbl</a></span><span class="op">(</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>state_id <span class="op">=</span> <span class="va">states</span><span class="op">$</span><span class="va">state_id</span>,
             mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.8</span>, S <span class="op">=</span> <span class="fl">.6</span><span class="op">)</span>,
             se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">.05</span><span class="op">)</span>
  <span class="op">)</span>,
  dist <span class="op">=</span> <span class="st">"beta"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">utility_tbl</span><span class="op">)</span></code></pre></div>
<pre><code>##    state_id mean   se
## 1:        1  0.8 0.02
## 2:        2  0.6 0.05</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Medical costs</span>
<span class="va">medcost_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/stateval_tbl.html">stateval_tbl</a></span><span class="op">(</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>state_id <span class="op">=</span> <span class="va">states</span><span class="op">$</span><span class="va">state_id</span>,
             mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">9500</span><span class="op">)</span>,
             se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">9500</span><span class="op">)</span>
  <span class="op">)</span>,
  dist <span class="op">=</span> <span class="st">"gamma"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">medcost_tbl</span><span class="op">)</span></code></pre></div>
<pre><code>##    state_id mean   se
## 1:        1 2000 2000
## 2:        2 9500 9500</code></pre>
<p>Treatment costs are, on the other hand, treated slightly differently. Since the model is not semi-Markov, they cannot vary as a function of time since entering the progression state. One way to accommodate this is to use the survival models for PFS and OS fits to parameterize a cDTSTM as described above and create a number of tunnel states following progression. For instance, if we constructed a model with monthly cycles, then 4 progression states would be required (progression month 1, progression month 2, progression month 3, and progression month &gt; 3). However, for simplicity, we will assume treatment costs are constant in the progression state and continue to use the area under the curve approach.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">drugcost_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/stateval_tbl.html">stateval_tbl</a></span><span class="op">(</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>strategy_id <span class="op">=</span> <span class="va">strategies</span><span class="op">$</span><span class="va">strategy_id</span>,
             est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">12000</span><span class="op">)</span><span class="op">)</span>,
  dist <span class="op">=</span> <span class="st">"fixed"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">drugcost_tbl</span><span class="op">)</span></code></pre></div>
<pre><code>##    strategy_id   est
## 1:           1  2000
## 2:           2 12000</code></pre>
</div>
</div>
<div id="simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation" class="anchor"></a>Simulation</h1>
<div id="constructing-the-economic-model" class="section level2">
<h2 class="hasAnchor">
<a href="#constructing-the-economic-model" class="anchor"></a>Constructing the economic model</h2>
<p>As in all models that perform probabilistic sensitivity analysis (PSA), we set the number of PSA iterations. Note that we use a smaller number of iterations because will will sample parameters from the survival models using bootstrapping, which takes longer to run than sampling directly from probability distributions like we have done previously. For instance, in the multi-state model, we sampled the parameters from their multivariate normal asymptotic distribution.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">100</span></code></pre></div>
</div>
<div id="survival-models-1" class="section level2">
<h2 class="hasAnchor">
<a href="#survival-models-1" class="anchor"></a>Survival models</h2>
<p>Survival predictions are made as a function of the fitted Weibull models and input data. The latter consists of each treatment strategy and patient combination.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Input data for survival models</span>
<span class="va">survmods_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/expand.html">expand</a></span><span class="op">(</span><span class="va">hesim_dat</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"strategies"</span>, <span class="st">"patients"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">survmods_data</span><span class="op">)</span></code></pre></div>
<pre><code>##    strategy_id patient_id strategy_name patient_wt age female
## 1:           1          1           SOC       0.25  45      0
## 2:           1          2           SOC       0.25  45      1
## 3:           1          3           SOC       0.25  65      0
## 4:           1          4           SOC       0.25  65      1
## 5:           2          1           New       0.25  45      0
## 6:           2          2           New       0.25  45      1
## 7:           2          3           New       0.25  65      0
## 8:           2          4           New       0.25  65      1</code></pre>
<p>In addition, we must also specify arguments related to the PSA. As mentioned above, we sample the parameters via bootstrapping, whereby the survival models are refit repeatedly to resamples of the estimation dataset. The advantage of this approach is that it preserves the correlation between PFS and OS and reduces the chances that the curves cross.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">survmods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/create_PsmCurves.html">create_PsmCurves</a></span><span class="op">(</span><span class="va">psfit_wei</span>, 
                             input_data <span class="op">=</span> <span class="va">survmods_data</span>, 
                             n <span class="op">=</span> <span class="va">n_samples</span>,
                             uncertainty <span class="op">=</span> <span class="st">"bootstrap"</span>, 
                             est_data <span class="op">=</span> <span class="va">surv_est_data</span><span class="op">)</span></code></pre></div>
<div id="utility-and-cost-models" class="section level3">
<h3 class="hasAnchor">
<a href="#utility-and-cost-models" class="anchor"></a>Utility and cost models</h3>
<p>The same code from the multi-state model is used to setup the cost and utility models.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Utility</span>
<span class="va">utilitymod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/create_StateVals.html">create_StateVals</a></span><span class="op">(</span><span class="va">utility_tbl</span>, n <span class="op">=</span> <span class="va">n_samples</span>,
                               hesim_data <span class="op">=</span> <span class="va">hesim_dat</span><span class="op">)</span>

<span class="co"># Costs</span>
<span class="va">drugcostmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/create_StateVals.html">create_StateVals</a></span><span class="op">(</span><span class="va">drugcost_tbl</span>, n <span class="op">=</span> <span class="va">n_samples</span>,
                                hesim_data <span class="op">=</span> <span class="va">hesim_dat</span><span class="op">)</span>
<span class="va">medcostmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/create_StateVals.html">create_StateVals</a></span><span class="op">(</span><span class="va">medcost_tbl</span>, n <span class="op">=</span> <span class="va">n_samples</span>,
                               hesim_data <span class="op">=</span> <span class="va">hesim_dat</span><span class="op">)</span>
<span class="va">costmods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Drug <span class="op">=</span> <span class="va">drugcostmod</span>,
                 Medical <span class="op">=</span> <span class="va">medcostmod</span><span class="op">)</span></code></pre></div>
</div>
<div id="combining-the-disease-progression-cost-and-utility-models" class="section level3">
<h3 class="hasAnchor">
<a href="#combining-the-disease-progression-cost-and-utility-models" class="anchor"></a>Combining the disease progression, cost, and utility models</h3>
<p>As in the multi-state model, we initialize the economic model by combining the disease, utility, and costs models using the <code>$new()</code> method.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">econmod</span> <span class="op">&lt;-</span> <span class="va"><a href="https://hesim-dev.github.io/hesim/reference/Psm.html">Psm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>survival_models <span class="op">=</span> <span class="va">survmods</span>,
                   utility_model <span class="op">=</span> <span class="va">utilitymod</span>,
                   cost_models <span class="op">=</span> <span class="va">costmods</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="simulating-outcomes" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-outcomes" class="anchor"></a>Simulating outcomes</h2>
<div id="survival-curves" class="section level3">
<h3 class="hasAnchor">
<a href="#survival-curves" class="anchor"></a>Survival curves</h3>
<p>Once the PSM has been initialized, the <code>$sim_survival()</code> method can be used to generate survival curves for each endpoint.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, by <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span>
<span class="va">econmod</span><span class="op">$</span><span class="fu">sim_survival</span><span class="op">(</span>t <span class="op">=</span> <span class="va">times</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">econmod</span><span class="op">$</span><span class="va">survival_</span>, ci <span class="op">=</span> <span class="cn">TRUE</span>,
         labels <span class="op">=</span> <span class="va">labs</span><span class="op">)</span></code></pre></div>
<p><img src="05-psm_files/figure-html/sim_survival-1.png" width="700"></p>
<p>We can, in theory, plot these curves for each treatment strategy and patient. To summarize, however, we will plot the average (across patients) survival curves for each treatment strategy. The probabilities of being in the stable, progression, and death states are the area under the PFS curves, the area between the OS and PFS curves, and the area above the OS curve, respectively.</p>
<p><img src="05-psm_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div id="health-state-probabilities" class="section level3">
<h3 class="hasAnchor">
<a href="#health-state-probabilities" class="anchor"></a>Health state probabilities</h3>
<p>These health state probabilities are computed using the <code>$sim_stateprobs()</code> method. For example, let’s look at probabilities in the progression state at year 12 using the first PSA sample.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">econmod</span><span class="op">$</span><span class="fu">sim_stateprobs</span><span class="op">(</span><span class="op">)</span>
<span class="va">econmod</span><span class="op">$</span><span class="va">stateprobs_</span><span class="op">[</span><span class="va">sample</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">state_id</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">t</span> <span class="op">==</span> <span class="fl">12</span><span class="op">]</span></code></pre></div>
<pre><code>##    sample strategy_id patient_id grp_id patient_wt state_id  t      prob
## 1:      1           1          1      1       0.25        2 12 0.3677102
## 2:      1           1          2      1       0.25        2 12 0.3101250
## 3:      1           1          3      1       0.25        2 12 0.3677102
## 4:      1           1          4      1       0.25        2 12 0.3101250
## 5:      1           2          1      1       0.25        2 12 0.4374124
## 6:      1           2          2      1       0.25        2 12 0.4317433
## 7:      1           2          3      1       0.25        2 12 0.4374124
## 8:      1           2          4      1       0.25        2 12 0.4317433</code></pre>
</div>
<div id="utility-and-costs-1" class="section level3">
<h3 class="hasAnchor">
<a href="#utility-and-costs-1" class="anchor"></a>Utility and costs</h3>
<p>Utility and costs are computed in the same manner as in the other <code>hesim</code> models.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">econmod</span><span class="op">$</span><span class="fu">sim_costs</span><span class="op">(</span>dr <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span>
<span class="va">econmod</span><span class="op">$</span><span class="fu">sim_qalys</span><span class="op">(</span>dr <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div id="cost-effectiveness-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#cost-effectiveness-analysis" class="anchor"></a>Cost-effectiveness analysis</h1>
<p>Since the cost and QALY output is the same regardless of the model type, the cost-effectiveness analysis (CEA) proceeds in the same way as when using the Markov cohort and multi-state modeling approaches.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ce_sim</span> <span class="op">&lt;-</span> <span class="va">econmod</span><span class="op">$</span><span class="fu">summarize</span><span class="op">(</span><span class="op">)</span>
<span class="va">cea_pw_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/cea.html">cea_pw</a></span><span class="op">(</span><span class="va">ce_sim</span>, comparator <span class="op">=</span> <span class="fl">1</span>, dr_qalys <span class="op">=</span> <span class="fl">.03</span>, dr_costs <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/icer.html">icer</a></span><span class="op">(</span><span class="va">cea_pw_out</span>, labels <span class="op">=</span> <span class="va">labs</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##              Outcome                        New
## 1: Incremental QALYs          0.88 (0.61, 1.17)
## 2: Incremental costs  102,746 (92,119, 113,340)
## 3:   Incremental NMB -58,941 (-70,112, -48,391)
## 4:              ICER                    117,277</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Devin Incerti, Jeroen P. Jansen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
