<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Incorporating Probabilistic Sensitivity Analysis • rcea</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Incorporating Probabilistic Sensitivity Analysis">
<meta property="og:description" content="rcea">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131661920-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-131661920-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rcea</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-markov-cohort.html">Simple Markov Cohort Model</a>
    </li>
    <li>
      <a href="../articles/02-markov-cohort-psa.html">Incorporating Probabilistic Sensitivity Analysis</a>
    </li>
    <li>
      <a href="../articles/03-markov-cohort-hesim.html">Markov Cohort Model with hesim</a>
    </li>
    <li>
      <a href="../articles/04-mstate.html">Semi-Markov Multi-state Model</a>
    </li>
    <li>
      <a href="../articles/05-psm.html">Partitioned Survival Model</a>
    </li>
    <li>
      <a href="../articles/06-cea.html">Cost-effectiveness Analysis</a>
    </li>
    <li class="divider">
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Slides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../slides-3hr.pdf">3 hour course</a>
    </li>
    <li>
      <a href="../slides-4hr.pdf">4 hour course</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hesim-dev/rcea/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="02-markov-cohort-psa_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Incorporating Probabilistic Sensitivity Analysis</h1>
            
            <h4 class="date">2021-08-13</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/hesim-dev/rcea/blob/master/vignettes/02-markov-cohort-psa.Rmd"><code>vignettes/02-markov-cohort-psa.Rmd</code></a></small>
      <div class="hidden name"><code>02-markov-cohort-psa.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>Probabilistic sensitivity analysis (PSA) is used to quantify the impact of parameter uncertainty on the uncertainty of model outputs. PSA is typically performed via a simulation approach whereby the model parameters are randomly sampled from suitable probability distributions and the entire model is simulated for each random draw of the parameters.</p>
<p>In this example, we extend the deterministic <a href="01-markov-cohort.html">simple Markov cohort model</a> to incorporate PSA. We will continue to rely primarily on Base <code>R</code> but will use the <code>hesim</code> package to help make the code more readable.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://hesim-dev.github.io/rcea/">"rcea"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://hesim-dev.github.io/hesim/">"hesim"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://r-datatable.com">"data.table"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://magrittr.tidyverse.org">"magrittr"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org">"ggplot2"</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="model-parameters" class="section level1">
<h1 class="hasAnchor">
<a href="#model-parameters" class="anchor"></a>Model parameters</h1>
<div id="transition-probabilities-for-soc" class="section level2">
<h2 class="hasAnchor">
<a href="#transition-probabilities-for-soc" class="anchor"></a>Transition probabilities for SOC</h2>
<p>The probability distribution used for transition probabilities will depend on the underlying data. In this case, we assume that summary level data is available on transitions from the Healthy state (n = 900), Sick state (n = 900), and Sicker state (n = 800). The transitions from each state to the other 4 states can be modeled using a Dirichlet distribution (see Appendix).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">transitions_soc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">848</span>, <span class="fl">150</span>, <span class="fl">0</span>,   <span class="fl">2</span>,
    <span class="fl">500</span>, <span class="fl">389</span>, <span class="fl">105</span>,  <span class="fl">6</span>,
    <span class="fl">0</span>,   <span class="fl">0</span>,   <span class="fl">784</span>, <span class="fl">16</span>,
    <span class="fl">0</span>,   <span class="fl">0</span>,   <span class="fl">0</span>,   <span class="fl">23</span><span class="op">)</span>,
  nrow <span class="op">=</span> <span class="fl">4</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">state_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"H"</span>, <span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"D"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">transitions_soc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span><span class="op">(</span><span class="va">transitions_soc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="va">state_names</span><span class="op">)</span></code></pre></div>
</div>
<div id="relative-risk" class="section level2">
<h2 class="hasAnchor">
<a href="#relative-risk" class="anchor"></a>Relative risk</h2>
<p>We estimate treatment effects in terms of the log relative risk since it is approximately normally distributed; that is, the relative risk follows a lognormal distribution. The mean is given by the log of the point estimate of the relative risk, or <span class="math inline">\(log(0.8)\)</span>.</p>
<p>Since academic studies often report 95% confidence intervals for a parameter, but not its standard error, we will assume that is the case. Specifically, let the lower bound be <span class="math inline">\(log(0.71)\)</span> and the upper bound be <span class="math inline">\(log(0.91)\)</span>. The standard error is then given by <span class="math inline">\((log(0.91) - log(0.71))/2z\)</span> where <span class="math inline">\(z = \Phi^{-1}(0.975)\approx 1.96\)</span>. See the Appendix for details.</p>
</div>
<div id="costs" class="section level2">
<h2 class="hasAnchor">
<a href="#costs" class="anchor"></a>Costs</h2>
<div id="medical-costs" class="section level3">
<h3 class="hasAnchor">
<a href="#medical-costs" class="anchor"></a>Medical costs</h3>
<p>Medical costs are of often assumed to follow a gamma distribution because it can be used to model right skewed distributions. The gamma distribution is defined in terms of a shape and scale (or rate) parameter. However, these parameters can be derived form the mean and standard deviation of a distribution using the <a href="https://hesim-dev.github.io/hesim/reference/mom_gamma.html">method of moments</a>. Mean costs follow those in the deterministic example (H = $2,000, S1 = $4,000, S2 = $2,000), D = <span class="math inline">\(0\)</span>). The standard deviation in each state is assumed to be equal to the mean.</p>
</div>
<div id="treatment-costs" class="section level3">
<h3 class="hasAnchor">
<a href="#treatment-costs" class="anchor"></a>Treatment costs</h3>
<p>Treatment costs are fixed and equal to the costs in the deterministic example.</p>
</div>
</div>
<div id="utility" class="section level2">
<h2 class="hasAnchor">
<a href="#utility" class="anchor"></a>Utility</h2>
<p>The utility associated with each state is assumed to follow a beta distribution, which is bounded between 0 and 1. The beta distribution is defined in terms of 2 shape parameters, but like the gamma distribution , these can be derived using the <a href="https://hesim-dev.github.io/hesim/reference/mom_beta.html">method of moments</a>. We assume that the mean (standard error) of utility is estimated to be <span class="math inline">\(1\)</span> <span class="math inline">\((0.0)\)</span>, <span class="math inline">\(0.75\)</span> <span class="math inline">\((0.03)\)</span>, <span class="math inline">\(0.5\)</span> <span class="math inline">\((0.05)\)</span>, and <span class="math inline">\(0\)</span> <span class="math inline">\((0.0)\)</span> in state H, S1, S2, and D, respectively.</p>
</div>
<div id="combining-the-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#combining-the-parameters" class="anchor"></a>Combining the parameters</h2>
<p>All model parameters (transition probabilities, relative risk, costs, and utility) can be stored in a list for use in the simulation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  alpha_soc <span class="op">=</span> <span class="va">transitions_soc</span>,
  lrr_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">.8</span><span class="op">)</span>,
  lrr_lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">.71</span><span class="op">)</span>,
  lrr_upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">.9</span><span class="op">)</span>,
  c_medical <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>H <span class="op">=</span> <span class="fl">2000</span>, S1 <span class="op">=</span> <span class="fl">4000</span>, S2 <span class="op">=</span> <span class="fl">15000</span>, D <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
  c_soc <span class="op">=</span> <span class="fl">2000</span>,
  c_new <span class="op">=</span> <span class="fl">12000</span>,
  u_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>H <span class="op">=</span> <span class="fl">1</span>, S1 <span class="op">=</span> <span class="fl">.75</span>, S2 <span class="op">=</span> <span class="fl">0.5</span>, D <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
  u_se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>H <span class="op">=</span> <span class="fl">0</span>, S1 <span class="op">=</span> <span class="fl">0.03</span>, S2 <span class="op">=</span> <span class="fl">0.05</span>, D <span class="op">=</span> <span class="fl">0.0</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
</div>
<div id="simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation" class="anchor"></a>Simulation</h1>
<p>The simulation proceeds by (i) randomly sampling the parameters from the probability distributions specified above and (ii) running the Markov model for each draw of the parameters. The result is a draw from the probability distribution of each of the model outputs of interest (i.e, state probabilities, QALYs, and costs).</p>
<div id="sampling-the-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#sampling-the-parameters" class="anchor"></a>Sampling the parameters</h2>
<p>While Base R can certainly be used to draw samples of the parameters, the functions <code><a href="https://hesim-dev.github.io/hesim/reference/define_rng.html">hesim::define_rng()</a></code> and <code><a href="https://hesim-dev.github.io/hesim/reference/define_rng.html">hesim::eval_rng()</a></code> simplify this process and make the code more readable. Any random number generation function can be used inside the <code><a href="https://hesim-dev.github.io/hesim/reference/define_rng.html">define_rng()</a></code> block; the only rule is that returned parameter draws must be returned as a list. However, <code>hesim</code> comes with a number of helpful probability distribution functions (type <code><a href="https://hesim-dev.github.io/hesim/reference/rng_distributions.html">?rng_distributions</a></code> for details) to make your life easier.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rng_def</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/define_rng.html">define_rng</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">lrr_se</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">lrr_upper</span> <span class="op">-</span> <span class="va">lrr_lower</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.975</span><span class="op">)</span><span class="op">)</span> <span class="co"># Local object </span>
  <span class="co"># not returned</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="co"># Parameters to return</span>
    p_soc <span class="op">=</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/rng_distributions.html">dirichlet_rng</a></span><span class="op">(</span><span class="va">alpha_soc</span><span class="op">)</span>,
    rr_new <span class="op">=</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/rng_distributions.html">lognormal_rng</a></span><span class="op">(</span><span class="va">lrr_mean</span>, <span class="va">lrr_se</span><span class="op">)</span>,
    c_medical <span class="op">=</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/rng_distributions.html">gamma_rng</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">c_medical</span>, sd <span class="op">=</span> <span class="va">c_medical</span><span class="op">)</span>,
    c_soc <span class="op">=</span> <span class="va">c_soc</span>,
    c_new <span class="op">=</span> <span class="va">c_new</span>,
    u <span class="op">=</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/rng_distributions.html">beta_rng</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">u_mean</span>, sd <span class="op">=</span> <span class="va">u_se</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>, n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="va">params_rng</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/define_rng.html">eval_rng</a></span><span class="op">(</span><span class="va">rng_def</span>, params <span class="op">=</span> <span class="va">params</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">params_rng</span>, <span class="st">"n"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">rng_def</span><span class="op">$</span><span class="va">n</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">params_rng</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "p_soc"     "rr_new"    "c_medical" "c_soc"     "c_new"     "u"</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">params_rng</span><span class="op">$</span><span class="va">p_soc</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##            h_h      h_s1 h_s2          h_d      s1_h     s1_s1      s1_s2
## [1,] 0.8576744 0.1371577    0 0.0051678855 0.4905395 0.3854928 0.11966318
## [2,] 0.8607883 0.1381983    0 0.0010134092 0.4988604 0.3854906 0.11255637
## [3,] 0.8566195 0.1401410    0 0.0032394649 0.4808617 0.4228941 0.08941584
## [4,] 0.8284717 0.1700769    0 0.0014513110 0.4878553 0.3972332 0.10660321
## [5,] 0.8501356 0.1489625    0 0.0009018941 0.4829555 0.3939509 0.11816168
## [6,] 0.8690153 0.1297576    0 0.0012271680 0.4948654 0.3866361 0.11625030
##             s1_d s2_h s2_s1     s2_s2       s2_d d_h d_s1 d_s2 d_d
## [1,] 0.004304514    0     0 0.9765248 0.02347521   0    0    0   1
## [2,] 0.003092684    0     0 0.9802642 0.01973583   0    0    0   1
## [3,] 0.006828379    0     0 0.9817523 0.01824771   0    0    0   1
## [4,] 0.008308343    0     0 0.9812838 0.01871620   0    0    0   1
## [5,] 0.004931905    0     0 0.9791541 0.02084594   0    0    0   1
## [6,] 0.002248216    0     0 0.9816755 0.01832455   0    0    0   1</code></pre>
</div>
<div id="simulating-the-markov-model" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-the-markov-model" class="anchor"></a>Simulating the Markov model</h2>
<p>Once samples of the parameters have been drawn, the Markov model can be simulated for each draw.</p>
<div id="input-data" class="section level3">
<h3 class="hasAnchor">
<a href="#input-data" class="anchor"></a>Input data</h3>
<p>One way that a Markov simulation can be generalized is to store “input data” in an object such as a data frame. This <code>input data</code> might consist of different treatment strategies, patients and/or subgroups, or even information about the health states themselves. For instance, if we were simulating different subgroups we might store the age and sex associated with the subgroup which could, in turn, be used as covariates in a statistical model. In this simple example the data will just consist of the names of the two treatment strategies.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  strategy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"New"</span>, <span class="st">"SOC"</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></code></pre></div>
<pre><code>##   strategy
## 1      New
## 2      SOC</code></pre>
</div>
<div id="running-the-simulation" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-simulation" class="anchor"></a>Running the simulation</h3>
<p>It is a good idea to modularize your R code into functions. This can make your code more readable, maintainable, and reusable. We will work toward a <code>sim_model()</code> function that runs the entire simulation. It will be comprised of three smaller functions: <code><a href="https://hesim-dev.github.io/hesim/reference/sim_stateprobs.html">sim_stateprobs()</a></code>, <code>compute_qalys()</code>, and <code>compute_costs()</code>.</p>
<p>The <code><a href="https://hesim-dev.github.io/hesim/reference/sim_stateprobs.html">sim_stateprobs()</a></code> function will simulate health state probabilities for each model cycle (i.e., the Markov trace) for a given treatment strategy and parameter sample. It takes the arguments:</p>
<ul>
<li>
<code>p0</code>: the transition probability matrix for SOC,</li>
<li>
<code>rr</code>: the relative risk)</li>
<li>
<code>strategy</code>: the name of the treatment strategy as defined in <code>data</code> above.</li>
<li>
<code>n_cycles</code>: The number of cycles to simulate the model for.</li>
</ul>
<p>To make the code more readable, we will use the function <code><a href="https://hesim-dev.github.io/hesim/reference/tpmatrix.html">hesim::tpmatrix()</a></code> which makes it easy to define a transition probability matrix. The symbol <code>C</code> denotes that a given element is the complement of all other elements in that row, ensuring that the probabilities sum to 1.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_stateprobs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p0</span>, <span class="va">rr</span>, <span class="va">strategy</span>, <span class="va">n_cycles</span><span class="op">)</span><span class="op">{</span>
  <span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">strategy</span> <span class="op">==</span> <span class="st">"New"</span>, <span class="va">rr</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/tpmatrix.html">tpmatrix</a></span><span class="op">(</span>
    <span class="va">C</span>,       <span class="va">p0</span><span class="op">$</span><span class="va">h_s1</span> <span class="op">*</span> <span class="va">rr</span>,  <span class="va">p0</span><span class="op">$</span><span class="va">h_s2</span> <span class="op">*</span> <span class="va">rr</span>,  <span class="va">p0</span><span class="op">$</span><span class="va">h_d</span> <span class="op">*</span> <span class="va">rr</span>,
    <span class="va">p0</span><span class="op">$</span><span class="va">s1_h</span>, <span class="va">C</span>,             <span class="va">p0</span><span class="op">$</span><span class="va">s1_s2</span> <span class="op">*</span> <span class="va">rr</span>, <span class="va">p0</span><span class="op">$</span><span class="va">s1_d</span> <span class="op">*</span> <span class="va">rr</span>,
    <span class="va">p0</span><span class="op">$</span><span class="va">s2_h</span>, <span class="va">p0</span><span class="op">$</span><span class="va">s2_s1</span>,      <span class="va">C</span>,             <span class="va">p0</span><span class="op">$</span><span class="va">s2_d</span> <span class="op">*</span> <span class="va">rr</span>,
    <span class="fl">0</span>,       <span class="fl">0</span>,             <span class="fl">0</span>,             <span class="fl">1</span>
  <span class="op">)</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_markov_chain.html">sim_markov_chain</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
                        p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">4</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                        n_cycles <span class="op">=</span> <span class="va">n_cycles</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>To compute (discounted) QALYs for a given Markov trace, we will use a very simple function that is identical to the <code>compute_qalys</code> function used in the deterministic example.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compute_qalys</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">utility</span>, <span class="va">dr</span> <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span><span class="op">{</span>
  <span class="va">n_cycles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
  <span class="fu"><a href="../reference/pv.html">pv</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%*%</span> <span class="va">utility</span>, <span class="va">dr</span>, <span class="fl">0</span><span class="op">:</span><span class="va">n_cycles</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Similarly, our cost function is nearly identical to the <code>compute_costs()</code> function from the deterministic example.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compute_costs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">costs_medical</span>, <span class="va">costs_treat</span>, <span class="va">dr</span> <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span><span class="op">{</span>
  <span class="va">n_cycles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>
  <span class="va">costs_treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">costs_treat</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>
  <span class="va">costs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/pv.html">pv</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%*%</span> <span class="va">costs_medical</span>, <span class="va">dr</span>, <span class="fl">0</span><span class="op">:</span><span class="va">n_cycles</span><span class="op">)</span>,
    <span class="fu"><a href="../reference/pv.html">pv</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%*%</span> <span class="va">costs_treat</span>, <span class="va">dr</span>, <span class="fl">0</span><span class="op">:</span><span class="va">n_cycles</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">costs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dcost_med"</span>, <span class="st">"dcost_treat"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">costs</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now that we have created the building blocks for the simulation, we can create our main function to simulate the entire model. 3% discount rates are set by default for costs and QALYs. Most of the function arguments should be self explanatory, but two are worth explaining:</p>
<ul>
<li>
<code>params_rng</code>: The output of <code><a href="https://hesim-dev.github.io/hesim/reference/define_rng.html">eval_rng()</a></code> above.</li>
<li>
<code>data</code>: The data object defined above</li>
</ul>
<p>The first part of the function creates an array to store the output. The array is a series of matrices each with <code>n_cycles</code> rows and columns for each output (i.e., state probabilities for the four health states, QALYs, treatment costs, and medical costs). There is one matrix for each parameter sample for the PSA and treatment strategy.</p>
<p>The second part of the function simulates state probabilities (with <code><a href="https://hesim-dev.github.io/hesim/reference/sim_stateprobs.html">sim_stateprobs()</a></code>), QALYs (with <code>compute_qalys()</code>), and costs (with <code>compute_costs()</code>) for each parameter sample and treatment strategy. The number of parameter samples and the names of the treatment strategies are saved as attributes (i.e., metadata) to the array which will be used below to convert the array to a data frame.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">params_rng</span>, <span class="va">data</span>, <span class="va">n_cycles</span> <span class="op">=</span> <span class="fl">85</span>, 
                      <span class="va">dr_qalys</span> <span class="op">=</span> <span class="fl">.03</span>, <span class="va">dr_costs</span> <span class="op">=</span> <span class="fl">.03</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># Initialize array of matrices</span>
  <span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">params_rng</span>, <span class="st">"n"</span><span class="op">)</span>
  <span class="va">n_strategies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">n_cycles</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">7</span>, <span class="va">n_samples</span> <span class="op">*</span> <span class="va">n_strategies</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="cn">NULL</span>, 
                        <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"H"</span>, <span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"D"</span>,
                          <span class="st">"dqalys"</span>, <span class="st">"dcosts_med"</span>, <span class="st">"dcosts_treat"</span><span class="op">)</span>, 
                        <span class="cn">NULL</span><span class="op">)</span>
  
  <span class="co"># Run the simulation</span>
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_samples</span><span class="op">)</span><span class="op">{</span> <span class="co"># Start PSA loop</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_strategies</span><span class="op">)</span> <span class="op">{</span> <span class="co"># Start treatment strategy loop</span>
      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hesim-dev.github.io/hesim/reference/sim_stateprobs.html">sim_stateprobs</a></span><span class="op">(</span>p0 <span class="op">=</span> <span class="va">params_rng</span><span class="op">$</span><span class="va">p_soc</span><span class="op">[</span><span class="va">s</span>, <span class="op">]</span>,
                          rr <span class="op">=</span> <span class="va">params_rng</span><span class="op">$</span><span class="va">rr_new</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,
                          strategy <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">strategy</span><span class="op">[</span><span class="va">k</span><span class="op">]</span>,
                          n_cycles <span class="op">=</span> <span class="va">n_cycles</span><span class="op">)</span>
      <span class="va">dqalys</span> <span class="op">&lt;-</span> <span class="fu">compute_qalys</span><span class="op">(</span><span class="va">x</span>, utility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">params_rng</span><span class="op">$</span><span class="va">u</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span>, 
                              dr <span class="op">=</span> <span class="va">dr_qalys</span><span class="op">)</span>
      <span class="va">dcosts</span> <span class="op">&lt;-</span> <span class="fu">compute_costs</span><span class="op">(</span><span class="va">x</span>, 
                              costs_medical <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">params_rng</span><span class="op">$</span><span class="va">c_medical</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span>, 
                              costs_treat <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">strategy</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">==</span> <span class="st">"SOC"</span>, 
                                                   <span class="va">params_rng</span><span class="op">$</span><span class="va">c_soc</span>,
                                                   <span class="va">params_rng</span><span class="op">$</span><span class="va">c_new</span><span class="op">)</span>,
                              dr <span class="op">=</span> <span class="va">dr_costs</span><span class="op">)</span>
      <span class="va">out</span><span class="op">[</span>, , <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">dqalys</span>, <span class="va">dcosts</span><span class="op">)</span>
      <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span>
    <span class="op">}</span> <span class="co"># End treatment strategy loop</span>
  <span class="op">}</span> <span class="co"># End PSA loop</span>
  
  <span class="co"># Store metadata and return</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">out</span>, <span class="st">"n_samples"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">n_samples</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">out</span>, <span class="st">"strategies"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">strategy</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now that we’ve written the function, lets simulate the model with argument defaults (85 model cycles and 3% discount rates). Recall that each array is a matrix.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_out</span> <span class="op">&lt;-</span> <span class="fu">sim_model</span><span class="op">(</span><span class="va">params_rng</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sim_out</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>##              H        S1          S2           D    dqalys dcosts_med
## [1,] 1.0000000 0.0000000 0.000000000 0.000000000 1.0000000   1901.016
## [2,] 0.8761213 0.1203956 0.000000000 0.003483085 0.9331267   2518.754
## [3,] 0.8296763 0.1534778 0.009646643 0.007199270 0.8894709   2714.428
## [4,] 0.8060452 0.1610746 0.021704687 0.011175595 0.8532616   2783.439
## [5,] 0.7892591 0.1612580 0.034072297 0.015410662 0.8199984   2810.255
## [6,] 0.7746470 0.1593101 0.046147807 0.019895071 0.7883799   2819.434
##      dcosts_treat
## [1,]     12000.00
## [2,]     11609.91
## [3,]     11229.72
## [4,]     10858.97
## [5,]     10497.54
## [6,]     10145.37</code></pre>
<p>Although arrays are computationally efficient objects for storing data, they aren’t often the most useful for summarizing data. We will write to short functions to convert a 3D array to a <code>data.table</code> (with ID columns for the parameter sample and treatment strategy) so that we can summarize outcomes for each parameter sample and treatment strategy very quickly. (Note that other packages such as <code>dplyr</code> could also be used but we prefer <code>data.table</code> for simulations because of its speed).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># rbind an array of matrices into a single matrix</span>
<span class="va">rbind_array</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">n_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">x_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html">aperm</a></span><span class="op">(</span><span class="va">x</span>, perm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                  nrow <span class="op">=</span> <span class="va">n_rows</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x_mat</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Convert the array into a long dataframe with ID columns</span>
<span class="va">array_to_dt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">id_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>cycle <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,
                       strategy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"strategies"</span><span class="op">)</span>,
                       sample <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"n_samples"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">x_mat</span> <span class="op">&lt;-</span> <span class="fu">rbind_array</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">id_df</span>, <span class="va">x_mat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">sim_out</span> <span class="op">&lt;-</span> <span class="fu">array_to_dt</span><span class="op">(</span><span class="va">sim_out</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sim_out</span><span class="op">)</span></code></pre></div>
<pre><code>##    cycle strategy sample         H        S1          S2           D    dqalys
## 1:     0      New      1 1.0000000 0.0000000 0.000000000 0.000000000 1.0000000
## 2:     1      New      1 0.8761213 0.1203956 0.000000000 0.003483085 0.9331267
## 3:     2      New      1 0.8296763 0.1534778 0.009646643 0.007199270 0.8894709
## 4:     3      New      1 0.8060452 0.1610746 0.021704687 0.011175595 0.8532616
## 5:     4      New      1 0.7892591 0.1612580 0.034072297 0.015410662 0.8199984
## 6:     5      New      1 0.7746470 0.1593101 0.046147807 0.019895071 0.7883799
##    dcosts_med dcosts_treat
## 1:   1901.016     12000.00
## 2:   2518.754     11609.91
## 3:   2714.428     11229.72
## 4:   2783.439     10858.97
## 5:   2810.255     10497.54
## 6:   2819.434     10145.37</code></pre>
</div>
</div>
</div>
<div id="cost-effectiveness-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#cost-effectiveness-analysis" class="anchor"></a>Cost-effectiveness analysis</h1>
<p>A cost-effectiveness analysis (CEA) can be performed using the simulation output. A PSA is typically used to represent decision uncertainty using the distribution of (discounted) QALYs and (discounted) total costs. As such, we will compute mean discounted QALYs and discounted costs by parameter sample and treatment strategy. As in the previous tutorial, we assume that transitions occur immediately and therefore exclude costs and QALYs measured at the start of the first model cycle.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ce_sim</span> <span class="op">&lt;-</span> <span class="va">sim_out</span><span class="op">[</span><span class="va">cycle</span> <span class="op">!=</span> <span class="fl">0</span>, 
                  <span class="fu">.</span><span class="op">(</span>dqalys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dqalys</span><span class="op">)</span>,
                    dcosts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dcosts_med</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dcosts_treat</span><span class="op">)</span><span class="op">)</span>, 
                  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample"</span>, <span class="st">"strategy"</span><span class="op">)</span><span class="op">]</span>
<span class="va">ce_sim</span></code></pre></div>
<pre><code>##       sample strategy   dqalys    dcosts
##    1:      1      New 22.46453 424193.11
##    2:      1      SOC 19.79403 171692.25
##    3:      2      New 24.63744 411513.48
##    4:      2      SOC 21.75544 139341.69
##    5:      3      New 21.94022 582726.30
##   ---                                   
## 1996:    998      SOC 20.36152  74070.17
## 1997:    999      New 24.32977 547848.32
## 1998:    999      SOC 22.45038 296303.99
## 1999:   1000      New 22.92601 469550.31
## 2000:   1000      SOC 20.85917 212142.96</code></pre>
<p>In the <a href="06-cea.html">CEA tutorial</a>, we provide a formal treatment of CEA and show how to analyze such output within such a framework. To do so, we will need to save the results for later.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">ce_sim</span>,  file <span class="op">=</span> <span class="st">"markov-cohort-ce_sim.rds"</span><span class="op">)</span></code></pre></div>
<p>In the two treatment strategy case its simpler to “widen” the data so that we can easily compute incremental QALYs and incremental costs.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ce_sim_wider</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/dcast.data.table.html">dcast</a></span><span class="op">(</span><span class="va">ce_sim</span>, <span class="va">sample</span> <span class="op">~</span> <span class="va">strategy</span>, 
                      value.var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dqalys"</span>, <span class="st">"dcosts"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ce_sim_wider</span></code></pre></div>
<pre><code>##       sample dqalys_New dqalys_SOC dcosts_New dcosts_SOC
##    1:      1   22.46453   19.79403   424193.1  171692.25
##    2:      2   24.63744   21.75544   411513.5  139341.69
##    3:      3   21.94022   20.99635   582726.3  330673.48
##    4:      4   23.39585   21.26487   457973.7  200523.01
##    5:      5   23.55769   21.19810   394077.7  112846.31
##   ---                                                   
##  996:    996   23.32635   21.03058   470554.5  214179.13
##  997:    997   23.22674   20.81661   504809.5  264268.24
##  998:    998   22.27161   20.36152   345012.4   74070.17
##  999:    999   24.32977   22.45038   547848.3  296303.99
## 1000:   1000   22.92601   20.85917   469550.3  212142.96</code></pre>
<p>The ICER is computed by taking means across all parameter samples.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ce_sim_wider</span><span class="op">[</span>, <span class="va">idcosts</span> <span class="op">:=</span> <span class="va">dcosts_New</span> <span class="op">-</span> <span class="va">dcosts_SOC</span><span class="op">]</span>
<span class="va">ce_sim_wider</span><span class="op">[</span>, <span class="va">idqalys</span> <span class="op">:=</span> <span class="va">dqalys_New</span> <span class="op">-</span> <span class="va">dqalys_SOC</span><span class="op">]</span>
<span class="va">ce_sim_wider</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>icer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">idcosts</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">idqalys</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>##        icer
## 1: 125028.7</code></pre>
<p>We can also use a cost-effectiveness plane to visually represent uncertainty in incremental QALYs and incremental costs. The dotted line represents willingness to pay for a QALY (in this example, $100,000) and points below the line are cost-effective while points above the line are not.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">format_dollar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"$"</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span><span class="op">(</span><span class="va">x</span>, format <span class="op">=</span> <span class="st">"d"</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ce_sim_wider</span><span class="op">$</span><span class="va">idcosts</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.2</span>
<span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ce_sim_wider</span><span class="op">$</span><span class="va">idqalys</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.2</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">ce_sim_wider</span>, 
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">idqalys</span>, y <span class="op">=</span> <span class="va">idcosts</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>  <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Incremental QALYs"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Incremental cost"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">ylim</span>, <span class="va">ylim</span><span class="op">)</span>,
                     labels <span class="op">=</span> <span class="va">format_dollar</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">xlim</span>, <span class="va">xlim</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">100000</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="02-markov-cohort-psa_files/figure-html/ceplane-1.png" width="700"></p>
</div>
<div id="appendix" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h1>
<div id="dirichlet-distribution" class="section level2">
<h2 class="hasAnchor">
<a href="#dirichlet-distribution" class="anchor"></a>Dirichlet distribution</h2>
<p>The multinomial distribution is a discrete probability distribution for the number of successes for each of k mutually exclusive categories in n trials. The probabilities of the categories are given by <span class="math inline">\(\pi_1,\ldots, \pi_k\)</span> with <span class="math inline">\(\sum_{j=1}^k \pi_j=1\)</span> and each <span class="math inline">\(\pi_j\)</span> defined on <span class="math inline">\([0,1]\)</span>. The Dirichlet distribution is parameterized by the concentration parameters <span class="math inline">\(\alpha_1,\ldots, \alpha_k\)</span> with <span class="math inline">\(\alpha_j &gt; 0\)</span>. Letting <span class="math inline">\(x_1,\ldots, x_k\)</span> denote the number of successes in each category, the prior distribution and likelihood are,</p>
<p><span class="math display">\[
\begin{aligned}
p(\pi_1,\ldots,\pi_k |\alpha_1,\ldots, \alpha_k) = \text{Dirichlet}(\alpha_1,\ldots,\alpha_k) \\
p(x_1,\ldots,x_k | \pi_1,\ldots,\pi_k) = \text{Multin}(n, \pi_1,\ldots,\pi_k).
\end{aligned}
\]</span></p>
</div>
<div id="confidence-intervals-and-standard-errors" class="section level2">
<h2 class="hasAnchor">
<a href="#confidence-intervals-and-standard-errors" class="anchor"></a>Confidence intervals and standard errors</h2>
<p>Let <span class="math inline">\(\theta\)</span> be a normally distributed random variable, <span class="math inline">\(\sigma\)</span> be the standard deviation of <span class="math inline">\(\theta\)</span>, and <span class="math inline">\(z = \Phi^{-1}(1 - \alpha/2)\)</span> for a given confidence level <span class="math inline">\(\alpha\)</span>. A confidence interval for <span class="math inline">\(\theta\)</span> is then given by <span class="math inline">\((\theta - z\sigma, \theta + z\sigma)\)</span> with width given by <span class="math inline">\(2z\sigma\)</span>. If lower and upper limits are given by <span class="math inline">\(\theta_L\)</span> and <span class="math inline">\(\theta_U\)</span>, <span class="math inline">\(\sigma\)</span> can be solved with</p>
<p><span class="math display">\[
\sigma = \frac{\theta_U - \theta_L}{2z}.
\]</span></p>
<p>A 95% confidence interval is evaluated with <span class="math inline">\(z = \Phi^{-1}(.975)\)</span>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Devin Incerti, Jeroen P. Jansen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
